{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _toConsumableArray from \"@babel/runtime/helpers/toConsumableArray\";\nimport _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\n\nvar _this = this,\n    _jsxFileName = \"/Users/satoshishimamurasecond/Desktop/SatoshiShimamura/60_Udemy/2020_ShopAppUsingReactNativeAndFirebase/src/Section06/src/screens/CreateReviewScreen.tsx\";\n\nimport React, { useContext, useLayoutEffect, useState } from \"react\";\nimport StyleSheet from \"react-native-web/dist/exports/StyleSheet\";\nimport SafeAreaView from \"react-native-web/dist/exports/SafeAreaView\";\nimport View from \"react-native-web/dist/exports/View\";\nimport Image from \"react-native-web/dist/exports/Image\";\nimport Alert from \"react-native-web/dist/exports/Alert\";\nimport firebase from \"firebase\";\nimport { createReviewRef, uploadImage } from \"../lib/firebase\";\nimport { pickImage } from \"../lib/image-picker\";\nimport { UserContext } from \"../contexts/userContexts\";\nimport { ReviewsContext } from \"../contexts/reviewsContext\";\nimport { getExtention } from \"../utils/file\";\nimport { IconButton } from \"../components/IconButton\";\nimport { TextArea } from \"../components/TextArea\";\nimport { StarInput } from \"../components/StarInput\";\nimport { Button } from \"../components/Button\";\nimport { Loading } from \"../components/Loading\";\nexport var CreateReviewScreen = function CreateReviewScreen(_ref) {\n  var navigation = _ref.navigation,\n      route = _ref.route;\n  var shop = route.params.shop;\n\n  var _useState = useState(\"\"),\n      _useState2 = _slicedToArray(_useState, 2),\n      text = _useState2[0],\n      setText = _useState2[1];\n\n  var _useState3 = useState(3),\n      _useState4 = _slicedToArray(_useState3, 2),\n      score = _useState4[0],\n      setScore = _useState4[1];\n\n  var _useContext = useContext(UserContext),\n      user = _useContext.user;\n\n  var _useState5 = useState(\"\"),\n      _useState6 = _slicedToArray(_useState5, 2),\n      imageUri = _useState6[0],\n      setImageUri = _useState6[1];\n\n  var _useState7 = useState(false),\n      _useState8 = _slicedToArray(_useState7, 2),\n      loading = _useState8[0],\n      setLoading = _useState8[1];\n\n  var _useContext2 = useContext(ReviewsContext),\n      reviews = _useContext2.reviews,\n      setReviews = _useContext2.setReviews;\n\n  useLayoutEffect(function () {\n    navigation.setOptions({\n      title: shop.name,\n      headerLeft: function headerLeft() {\n        return React.createElement(IconButton, {\n          onPress: function onPress() {\n            return navigation.goBack();\n          },\n          name: \"x\",\n          __self: _this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 42,\n            columnNumber: 9\n          }\n        });\n      }\n    });\n  }, [navigation, shop]);\n\n  var onSubmit = function onSubmit() {\n    var reviewRef, ext, storagePath, downloadUrl, review;\n    return _regeneratorRuntime.async(function onSubmit$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (!(!text || !imageUri)) {\n              _context.next = 3;\n              break;\n            }\n\n            Alert.alert(\"レビューまたは画像がありません\");\n            return _context.abrupt(\"return\");\n\n          case 3:\n            setLoading(true);\n            _context.next = 6;\n            return _regeneratorRuntime.awrap(createReviewRef(shop.id));\n\n          case 6:\n            reviewRef = _context.sent;\n            ext = getExtention(imageUri);\n            storagePath = \"reviews/\" + reviewRef.id + \".\" + ext;\n            _context.next = 11;\n            return _regeneratorRuntime.awrap(uploadImage(imageUri, storagePath));\n\n          case 11:\n            downloadUrl = _context.sent;\n            review = {\n              id: reviewRef.id,\n              user: {\n                name: user.name,\n                id: user.id\n              },\n              shop: {\n                name: shop.name,\n                id: shop.id\n              },\n              text: text,\n              score: score,\n              imageUrl: downloadUrl,\n              updatedAt: firebase.firestore.Timestamp.now(),\n              createdAt: firebase.firestore.Timestamp.now()\n            };\n            _context.next = 15;\n            return _regeneratorRuntime.awrap(reviewRef.set(review));\n\n          case 15:\n            setReviews([review].concat(_toConsumableArray(reviews)));\n            setLoading(false);\n            navigation.goBack();\n\n          case 18:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  };\n\n  var onPickImage = function onPickImage() {\n    var uri;\n    return _regeneratorRuntime.async(function onPickImage$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            _context2.next = 2;\n            return _regeneratorRuntime.awrap(pickImage());\n\n          case 2:\n            uri = _context2.sent;\n            setImageUri(uri);\n\n          case 4:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  };\n\n  return React.createElement(SafeAreaView, {\n    style: styles.container,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 95,\n      columnNumber: 5\n    }\n  }, React.createElement(StarInput, {\n    score: score,\n    onChangeScore: function onChangeScore(value) {\n      return setScore(value);\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 96,\n      columnNumber: 7\n    }\n  }), React.createElement(TextArea, {\n    value: text,\n    onChangeText: function onChangeText(value) {\n      return setText(value);\n    },\n    label: \"\\u30EC\\u30D3\\u30E5\\u30FC\",\n    placeholder: \"\\u30EC\\u30D3\\u30E5\\u30FC\\u3092\\u66F8\\u3044\\u3066\\u304F\\u3060\\u3055\\u3044\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 97,\n      columnNumber: 7\n    }\n  }), React.createElement(View, {\n    style: styles.container,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 103,\n      columnNumber: 7\n    }\n  }, React.createElement(IconButton, {\n    name: \"camera\",\n    onPress: onPickImage,\n    color: \"#ccc\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 104,\n      columnNumber: 10\n    }\n  }), !!imageUri && React.createElement(Image, {\n    source: {\n      uri: imageUri\n    },\n    style: styles.image,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 105,\n      columnNumber: 25\n    }\n  })), React.createElement(Button, {\n    text: \"\\u30EC\\u30D3\\u30E5\\u30FC\\u3092\\u6295\\u7A3F\\u3059\\u308B\",\n    onPress: onSubmit,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 107,\n      columnNumber: 7\n    }\n  }), React.createElement(Loading, {\n    visible: loading,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 108,\n      columnNumber: 7\n    }\n  }));\n};\nvar styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: \"#fff\"\n  },\n  photoCOntainer: {\n    margin: 8\n  },\n  image: {\n    width: 100,\n    height: 100,\n    margin: 8\n  }\n});","map":{"version":3,"sources":["/Users/satoshishimamurasecond/Desktop/SatoshiShimamura/60_Udemy/2020_ShopAppUsingReactNativeAndFirebase/src/Section06/src/screens/CreateReviewScreen.tsx"],"names":["React","useContext","useLayoutEffect","useState","firebase","createReviewRef","uploadImage","pickImage","UserContext","ReviewsContext","getExtention","IconButton","TextArea","StarInput","Button","Loading","CreateReviewScreen","navigation","route","shop","params","text","setText","score","setScore","user","imageUri","setImageUri","loading","setLoading","reviews","setReviews","setOptions","title","name","headerLeft","goBack","onSubmit","Alert","alert","id","reviewRef","ext","storagePath","downloadUrl","review","imageUrl","updatedAt","firestore","Timestamp","now","createdAt","set","onPickImage","uri","styles","container","value","image","StyleSheet","create","flex","backgroundColor","photoCOntainer","margin","width","height"],"mappings":"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","sourcesContent":["import React, { useContext, useLayoutEffect, useState } from \"react\";\nimport { StyleSheet, SafeAreaView, Text, View, Image, Alert } from \"react-native\";\nimport firebase from \"firebase\";\nimport {createReviewRef, uploadImage} from \"../lib/firebase\";\nimport { pickImage } from \"../lib/image-picker\";\nimport {UserContext} from \"../contexts/userContexts\";\nimport {ReviewsContext} from \"../contexts/reviewsContext\";\nimport {getExtention} from \"../utils/file\";\n/* components */\nimport { IconButton } from \"../components/IconButton\";\nimport { TextArea } from \"../components/TextArea\";\nimport { StarInput } from \"../components/StarInput\";\nimport { Button } from \"../components/Button\";\nimport { Loading } from \"../components/Loading\";\n/* types */\nimport { StackNavigationProp } from \"@react-navigation/stack\";\nimport { RootStackParamList } from \"../types/navigation\";\nimport { RouteProp } from \"@react-navigation/native\";\nimport { Review } from \"../types/review\";\n\ntype Props = {\n  navigation: StackNavigationProp<RootStackParamList, \"CreateReview\">;\n  route: RouteProp<RootStackParamList, \"CreateReview\">;\n};\n\nexport const CreateReviewScreen: React.FC<Props> = ({\n  navigation,\n  route,\n}: Props) => {\n  const { shop } = route.params;\n  const [text, setText] = useState<string>(\"\");\n  const [score, setScore] = useState<number>(3);\n  const {user} = useContext(UserContext);\n  const [imageUri, setImageUri] = useState<string>(\"\");\n  const [loading, setLoading] = useState<boolean>(false);\n  const { reviews, setReviews } = useContext(ReviewsContext);\n\n  useLayoutEffect(() => {\n    navigation.setOptions({\n      title: shop.name,\n      headerLeft: () => (\n        <IconButton onPress={() => navigation.goBack()} name=\"x\" />\n      ),\n    });\n  }, [navigation, shop]);\n\n  const onSubmit = async () => {\n    if(!text || !imageUri) {\n      Alert.alert(\"レビューまたは画像がありません\");\n      return;\n    }\n\n    setLoading(true);\n\n    //documentのIDを先に取得\n    const reviewRef = await createReviewRef(shop.id);\n\n    //storageのpathを決定\n    const ext = getExtention(imageUri);\n    const storagePath = \"reviews/\"+reviewRef.id+\".\"+ext;\n\n    //画像をstorageにアップロード\n    const downloadUrl = await uploadImage(imageUri, storagePath);\n\n    //reviewドキュメントを作る\n    const review = {\n      id: reviewRef.id,\n      user: {\n        name: user.name,\n        id: user.id,\n      },\n      shop: {\n        name: shop.name,\n        id: shop.id,\n      },\n      text,\n      score,\n      imageUrl: downloadUrl,\n      updatedAt: firebase.firestore.Timestamp.now(),\n      createdAt: firebase.firestore.Timestamp.now(),\n    } as Review;\n    await reviewRef.set(review);\n    //レビュー一覧に即時反映する\n    setReviews([review, ...reviews]);\n    setLoading(false);\n    navigation.goBack();\n  };\n\n  const onPickImage = async () =>{\n    const uri = await pickImage();\n    setImageUri(uri);\n  };\n\n  return (\n    <SafeAreaView style={styles.container}>\n      <StarInput score={score} onChangeScore={(value) => setScore(value)} />\n      <TextArea \n      　value={text} \n      　onChangeText={(value) => setText(value)} \n      　label=\"レビュー\"\n      　placeholder=\"レビューを書いてください\"\n      />\n      <View style={styles.container}>\n         <IconButton name=\"camera\" onPress={onPickImage} color=\"#ccc\" />\n         {!!imageUri && <Image source={{uri: imageUri}} style={styles.image} />}\n      </View>\n      <Button text=\"レビューを投稿する\" onPress={onSubmit} />\n      <Loading visible={loading} />\n    </SafeAreaView>\n  );\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: \"#fff\",\n  },\n  photoCOntainer: {\n    margin: 8,\n  },\n  image: {\n    width: 100,\n    height: 100,\n    margin: 8,\n  },\n});"]},"metadata":{},"sourceType":"module"}